name: AI Concept Discovery
on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  issues: write

env:
  MIN_ISSUE_PRIORITY: medium

jobs:
  discover-concepts:
    runs-on: ubuntu-latest
    name: Discover New Concepts & Best Practices
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PNPM
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Analyze Templates
        id: analyze
        run: |
          echo "Analyzing all templates for concept opportunities..."
          
          TEMPLATES="typescript-library next-ssr react-router-v7-spa react-router-v7-ssr tanstack-router-spa expo-react-native"
          
          CONCEPTS=""
          
          for TEMPLATE in $TEMPLATES; do
            echo "Analyzing $TEMPLATE..."
            
            # Check package.json for version information
            PACKAGE_JSON="templates/$TEMPLATE/package.json"
            if [ -f "$PACKAGE_JSON" ]; then
              # Extract major dependencies
              DEPS=$(jq -r '.dependencies + .devDependencies | keys[]' "$PACKAGE_JSON" | head -20)
              echo "Dependencies for $TEMPLATE: $DEPS"
            fi
          done
          
          echo "templates=$TEMPLATES" >> $GITHUB_OUTPUT

      - name: Identify Concept Opportunities
        id: concepts
        run: |
          OPPORTUNITIES=""
          
          # Framework version checks
          echo "Checking for framework updates..."
          OPPORTUNITIES="$OPPORTUNITIES
          - Review React Router v7 latest features and patterns
          - Check Next.js latest App Router patterns
          - Review TanStack Query v5 best practices
          - Evaluate Expo SDK latest features
          - Consider TypeScript 5.x new features
          "
          
          # Emerging patterns
          echo "Checking for emerging patterns..."
          OPPORTUNITIES="$OPPORTUNITIES
          - Server Components patterns across frameworks
          - Streaming SSR implementations
          - Edge runtime compatibility
          - React Compiler integration
          - Type-safe environment variables patterns
          "
          
          # Testing improvements
          echo "Checking for testing improvements..."
          OPPORTUNITIES="$OPPORTUNITIES
          - Playwright component testing patterns
          - MSW v2 integration improvements
          - Testing Library best practices updates
          - Visual regression testing approaches
          "
          
          # Developer experience
          echo "Checking for DX improvements..."
          OPPORTUNITIES="$OPPORTUNITIES
          - Build performance optimizations
          - Hot reload improvements
          - TypeScript performance tuning
          - ESLint v9 migration
          "
          
          echo "opportunities<<EOF" >> $GITHUB_OUTPUT
          echo "$OPPORTUNITIES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate Concept Issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const opportunities = `${{ steps.concepts.outputs.opportunities }}`;
            const lines = opportunities.split('\n').filter(line => line.trim().startsWith('-'));
            
            for (const line of lines) {
              const concept = line.replace(/^-\s*/, '').trim();
              if (!concept) continue;
              
              const title = `[Concept Discovery] ${concept}`;
              const body = `## ðŸ” AI-Discovered Concept Opportunity
              
              **Concept**: ${concept}
              
              **Discovery Date**: ${new Date().toISOString().split('T')[0]}
              
              **Context**:
              This concept was identified during automated ecosystem scanning as a potential improvement opportunity for one or more templates.
              
              **Next Steps**:
              1. **Validation Phase** (Use @requirements-analyst agent):
                 - Research the concept in depth
                 - Evaluate relevance to our templates
                 - Assess implementation complexity
                 - Identify affected templates
              
              2. **Design Phase** (Use @software-architect agent):
                 - Create architectural design
                 - Define implementation approach
                 - Identify potential risks
                 - Create ADR if needed
              
              3. **Implementation Phase** (Use template specialist agents):
                 - Implement in relevant templates
                 - Update documentation
                 - Add tests
                 - Verify consistency
              
              **Relevant Agents**:
              - @requirements-analyst - Initial research and validation
              - @software-architect - Design and architecture
              - Template specialists - Framework-specific implementation
              
              **Review Guidelines**:
              - Does this concept align with our template philosophy?
              - What value does it provide to template users?
              - What's the maintenance burden?
              - How does it affect template consistency?
              
              ---
              *This issue was automatically generated by AI concept discovery workflow.*
              *See [\`/docs/ai-workflows/README.md\`](/docs/ai-workflows/README.md) for details.*
              `;
              
              // Check if similar issue already exists
              const existingIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: 'ai-generated,concept-proposal',
                state: 'open'
              });
              
              const isDuplicate = existingIssues.data.some(issue => 
                issue.title.toLowerCase().includes(concept.toLowerCase().slice(0, 30))
              );
              
              if (!isDuplicate) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: ['ai-generated', 'concept-proposal', 'enhancement']
                });
                
                console.log(`Created issue: ${title}`);
              } else {
                console.log(`Skipping duplicate issue: ${title}`);
              }
            }

      - name: Create Summary Report
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const opportunities = `${{ steps.concepts.outputs.opportunities }}`;
            const lines = opportunities.split('\n').filter(line => line.trim().startsWith('-'));
            
            core.summary
              .addHeading('ðŸ” AI Concept Discovery Report')
              .addHeading(`Date: ${new Date().toISOString().split('T')[0]}`, 3)
              .addHeading('Discovered Opportunities', 3)
              .addList(lines.map(l => l.replace(/^-\s*/, '').trim()))
              .addHeading('Next Steps', 3)
              .addRaw(`
              1. Review generated issues with \`ai-generated\` and \`concept-proposal\` labels
              2. Validate concepts using @requirements-analyst agent
              3. Prioritize based on impact and effort
              4. Assign to appropriate team members or agents
              `)
              .addLink('View AI Workflows Documentation', '/docs/ai-workflows/README.md')
              .write();
