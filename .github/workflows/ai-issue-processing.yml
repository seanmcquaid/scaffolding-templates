name: AI Issue Processing (Ralph Workflow)
on:
  schedule:
    # Run every day at 8:00 AM UTC
    - cron: "0 8 * * *"
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: read
  issues: write

env:
  MAX_ISSUES_PER_RUN: 10

jobs:
  process-issues:
    runs-on: ubuntu-latest
    name: Process Outstanding Issues with Ralph Workflow
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"

      - name: Fetch Outstanding Issues
        id: fetch-issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Fetch open issues that haven't been processed by Ralph workflow yet
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: ${{ env.MAX_ISSUES_PER_RUN }},
              sort: 'created',
              direction: 'asc',
              labels: '' // No label filter - process all open issues
            });

            // Filter out issues that already have ralph-processed label
            const unprocessedIssues = issues.data.filter(issue => 
              !issue.labels.some(label => label.name === 'ralph-processed') &&
              !issue.pull_request // Exclude pull requests
            );

            console.log(`Found ${unprocessedIssues.length} unprocessed issues`);

            // Store issue data for processing
            const issueData = unprocessedIssues.map(issue => ({
              number: issue.number,
              title: issue.title,
              body: issue.body || '',
              labels: issue.labels.map(l => l.name),
              author: issue.user.login,
              created_at: issue.created_at
            }));

            return issueData;

      - name: Process Issues with Ralph Workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { execSync } = require('child_process');
            const issues = ${{ steps.fetch-issues.outputs.result }};

            if (!issues || issues.length === 0) {
              console.log('No issues to process');
              return;
            }

            console.log(`Processing ${issues.length} issues...`);

            for (const issue of issues) {
              console.log(`\nProcessing issue #${issue.number}: ${issue.title}`);
              
              // Use classify-issue.sh script to analyze the issue
              const title = issue.title.replace(/'/g, "'\\''");
              const body = (issue.body || '').replace(/'/g, "'\\''");
              
              let classification;
              try {
                const result = execSync(
                  `./scripts/classify-issue.sh '${title}' '${body}'`,
                  { encoding: 'utf8', maxBuffer: 10 * 1024 * 1024 }
                );
                classification = JSON.parse(result);
              } catch (error) {
                console.error(`Failed to classify issue #${issue.number}:`, error.message);
                continue;
              }
              
              const analysis = classification.analysis.trim();
              const suggestedAgents = classification.agents || [];
              const suggestedLabels = classification.labels || [];
              const nextSteps = classification.next_steps.trim();
              
              // Create Ralph workflow comment
              const ralphComment = `## ðŸ¤– Ralph Workflow Analysis
              
              **Automated Analysis Date**: ${new Date().toISOString().split('T')[0]}

              ### Issue Classification

              ${analysis}

              ### Suggested Agents

              ${suggestedAgents.join(', ')}

              ### Ralph Workflow: Plan â†’ Execute â†’ Review â†’ Iterate

              Following the "Ralph is a loop" methodology, here's the recommended approach:

              ${nextSteps}

              ### Key Principles

              âœ… **Always start in plan mode** - Understand before implementing
              âœ… **Use specialized agents** - Route to domain experts
              âœ… **Iterate based on feedback** - Review and refine
              âœ… **Maintain consistency** - Follow template patterns

              ### Additional Resources

              - [AI Workflows Documentation](/docs/ai-workflows.md)
              - [Custom Agents Guide](/agents/README.md)
              - [Repository Guidelines](/AGENTS.md)

              ---
              *This analysis was automatically generated by the Ralph Workflow. Please review and adjust as needed.*
              *To reprocess this issue, remove the \`ralph-processed\` label and wait for the next scheduled run.*
              `;
              
              try {
                // Post the Ralph workflow comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: ralphComment
                });
                
                // Add suggested labels
                if (suggestedLabels.length > 0) {
                  // Get existing labels
                  const existingLabels = issue.labels || [];
                  const newLabels = [...new Set([...existingLabels, ...suggestedLabels, 'ralph-processed'])];
                  
                  await github.rest.issues.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    labels: newLabels
                  });
                }
                
                console.log(`âœ“ Processed issue #${issue.number}`);
              } catch (error) {
                console.error(`âœ— Failed to process issue #${issue.number}:`, error.message);
              }
            }

      - name: Create Summary Report
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issues = ${{ steps.fetch-issues.outputs.result }};
            const processedCount = issues ? issues.length : 0;

            core.summary
              .addHeading('ðŸ¤– Ralph Workflow - Issue Processing Report')
              .addHeading(`Date: ${new Date().toISOString().split('T')[0]}`, 3)
              .addHeading('Summary', 3)
              .addRaw(`Processed ${processedCount} outstanding issue(s) with Ralph workflow analysis.`)
              .addHeading('What is Ralph Workflow?', 3)
              .addRaw(`
              Ralph workflow follows the "plan â†’ execute â†’ review â†’ iterate" methodology:
              
              1. **Plan Mode First**: Analyze and understand before acting
              2. **Agent Routing**: Direct issues to specialized agents
              3. **Structured Approach**: Provide clear next steps
              4. **Iterative Process**: Review and refine based on feedback
              `)
              .addHeading('Next Steps', 3)
              .addRaw(`
              1. Review issues with new \`ralph-processed\` label
              2. Follow the suggested Ralph workflow for each issue
              3. Tag relevant agents for specialized guidance
              4. Execute in plan mode: analyze â†’ design â†’ implement â†’ test
              `)
              .addLink('View AI Workflows Documentation', '/docs/ai-workflows.md')
              .write();
